generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String            @id @default(cuid())
  email                String            @unique
  password             String
  emailVerified        DateTime?
  verificationToken    String?
  name                 String
  region               NorwegianRegion
  postalCode           String?
  gender               Gender?
  birthYear            Int?
  profileImage         String?
  degree               String?
  education            String?
  certifications       String?
  bio                  String?
  privacyGender        PrivacySetting    @default(PUBLIC)
  privacyAge           PrivacySetting    @default(PUBLIC)
  privacyDocuments     PrivacySetting    @default(PUBLIC)
  privacyContact       PrivacySetting    @default(PUBLIC)
  privacyEducation     PrivacySetting    @default(PUBLIC)
  privacyCertifications PrivacySetting   @default(PUBLIC)
  privacyLocation      PrivacySetting    @default(PUBLIC)
  privacyPostalCode    PrivacySetting    @default(PUBLIC)
  privacyMemberSince   PrivacySetting    @default(PUBLIC)
  privacyLastActive    PrivacySetting    @default(PUBLIC)
  privacyActivity      PrivacySetting    @default(PUBLIC)
  privacyStats         PrivacySetting    @default(PUBLIC)
  teacherSessions      Int               @default(0)
  teacherStudents      Int               @default(0)
  studentSessions      Int               @default(0)
  studentTeachers      Int               @default(0)
  isActive             Boolean           @default(true)
  lastActive           DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  failedLoginAttempts  Int?              @default(0)
  lockedUntil          DateTime?
  chatParticipants     ChatParticipant[]
  reportedChats        ChatReport[]      @relation("ChatReportReporter")
  reviewedReports      ChatReport[]      @relation("ChatReportReviewer")
  documents            Document[]
  receivedInfoRequests InfoRequest[]     @relation("InfoRequestReceiver")
  sentInfoRequests     InfoRequest[]     @relation("InfoRequestSender")
  sentMessages         Message[]
  posts                Post[]
  sessions             UserSession[]

  @@index([region, isActive])
  @@index([email])
  @@index([lastActive])
  @@map("users")
}

model Post {
  id               String          @id @default(cuid())
  type             PostType
  title            String
  subject          Subject
  customSubject    String?
  ageGroups        AgeGroup[]
  description      String
  availableDays    String[]
  startTime        String
  endTime          String
  location         NorwegianRegion
  postnummer       String?
  hourlyRate       Decimal?        @db.Decimal(8, 2)
  hourlyRateMin    Decimal?        @db.Decimal(8, 2)
  hourlyRateMax    Decimal?        @db.Decimal(8, 2)
  currency         String          @default("NOK")
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  userId           String
  chats            Chat[]
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([type, subject, location, isActive])
  @@index([userId, isActive])
  @@index([createdAt])
  @@index([location, subject])
  @@map("posts")
}

model Chat {
  id            String            @id @default(cuid())
  relatedPostId String?
  isActive      Boolean           @default(true)
  lastMessageAt DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  appointments  Appointment[]
  participants  ChatParticipant[]
  reports       ChatReport[]
  relatedPost   Post?             @relation(fields: [relatedPostId], references: [id])
  messages      Message[]

  @@index([relatedPostId])
  @@index([lastMessageAt])
  @@map("chats")
}

model ChatParticipant {
  id          String    @id @default(cuid())
  chatId      String
  userId      String
  joinedAt    DateTime  @default(now())
  leftAt      DateTime?
  isActive    Boolean   @default(true)
  unreadCount Int       @default(0)
  lastReadAt  DateTime?
  chat        Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@index([userId, isActive])
  @@index([chatId, isActive])
  @@map("chat_participants")
}

model Message {
  id               String       @id @default(cuid())
  content          String
  content_search   String?
  type             MessageType  @default(TEXT)
  chatId           String
  senderId         String
  isEdited         Boolean      @default(false)
  editedAt         DateTime?
  sentAt           DateTime     @default(now())
  appointmentId    String?
  replyToMessageId String?
  appointment      Appointment? @relation(fields: [appointmentId], references: [id])
  chat             Chat         @relation(fields: [chatId], references: [id], onDelete: Cascade)
  replyTo          Message?     @relation("MessageReply", fields: [replyToMessageId], references: [id])
  replies          Message[]    @relation("MessageReply")
  sender           User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatId, sentAt])
  @@index([senderId])
  @@index([replyToMessageId])
  @@index([content_search])
  @@map("messages")
}

model Appointment {
  id                 String            @id @default(cuid())
  chatId             String
  dateTime           DateTime
  location           String
  specificLocation   String?
  duration           Int               @default(60)
  status             AppointmentStatus @default(PENDING)
  teacherReady       Boolean           @default(false)
  studentReady       Boolean           @default(false)
  bothCompleted      Boolean           @default(false)
  reminderTime       Int?
  notes              String?
  cancellationReason String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  chat               Chat              @relation(fields: [chatId], references: [id], onDelete: Cascade)
  messages           Message[]

  @@index([chatId, status])
  @@index([dateTime, status])
  @@map("appointments")
}

model Document {
  id                 String             @id @default(cuid())
  userId             String
  documentType       DocumentType
  fileName           String
  fileUrl            String
  fileSize           Int?
  mimeType           String?
  documentContent    String?
  encryptionMetadata String?
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt         DateTime?
  verificationNotes  String?
  uploadedAt         DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, documentType])
  @@index([verificationStatus])
  @@map("documents")
}

model InfoRequest {
  id              String    @id @default(cuid())
  senderId        String
  receiverId      String
  requestType     String
  message         String?
  status          String    @default("PENDING")
  responseMessage String?
  requestedAt     DateTime  @default(now())
  respondedAt     DateTime?
  receiver        User      @relation("InfoRequestReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  sender          User      @relation("InfoRequestSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId, requestType])
  @@index([receiverId, status])
  @@index([senderId])
  @@map("info_requests")
}

model ChatReport {
  id          String    @id @default(cuid())
  chatId      String
  reporterId  String
  reason      String
  description String?
  messageIds  String[]
  status      String    @default("PENDING")
  priority    String    @default("MEDIUM")
  reviewedBy  String?
  reviewNotes String?
  actionTaken String?
  createdAt   DateTime  @default(now())
  reviewedAt  DateTime?
  resolvedAt  DateTime?
  chat        Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  reporter    User      @relation("ChatReportReporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reviewer    User?     @relation("ChatReportReviewer", fields: [reviewedBy], references: [id])

  @@index([chatId, status])
  @@index([reporterId])
  @@index([status, priority])
  @@index([createdAt])
  @@map("chat_reports")
}

model UserSession {
  id           String   @id @default(cuid())
  userId       String
  ipAddress    String
  userAgent    String
  createdAt    DateTime @default(now())
  lastActivity DateTime @default(now())
  requestCount Int      @default(1)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, ipAddress])
  @@index([userId, lastActivity])
  @@index([ipAddress])
  @@map("user_sessions")
}

enum Gender {
  MALE
  FEMALE
  PREFER_NOT_TO_SAY
}

enum PrivacySetting {
  PUBLIC
  ON_REQUEST
  PRIVATE
}

enum PostType {
  TEACHER
  STUDENT
}

enum Subject {
  math
  english
  norwegian
  science
  programming
  sports
  art
  music
  childcare
  other
}

enum AgeGroup {
  PRESCHOOL_3_6
  PRIMARY_7_10
  MIDDLE_11_13
  SECONDARY_14_16
  HIGH_SCHOOL_17_19
  ADULTS_20_PLUS
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum DocumentType {
  PROFILE_IMAGE
  EDUCATION_CERTIFICATE
  ID_VERIFICATION
  TEACHING_CERTIFICATE
  OTHER_DOCUMENT
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum MessageType {
  TEXT
  APPOINTMENT_REQUEST
  APPOINTMENT_RESPONSE
  SYSTEM_MESSAGE
}

enum NorwegianRegion {
  OSLO
  BERGEN
  TRONDHEIM
  STAVANGER
  KRISTIANSAND
  FREDRIKSTAD
  SANDNES
  TROMSOE
  DRAMMEN
  ASKER
  BAERUM
  AKERSHUS
  OESTFOLD
  BUSKERUD
  VESTFOLD
  TELEMARK
  AUST_AGDER
  VEST_AGDER
  ROGALAND
  HORDALAND
  SOGN_OG_FJORDANE
  MOERE_OG_ROMSDAL
  SOER_TROENDELAG
  NORD_TROENDELAG
  NORDLAND
  TROMS
  FINNMARK
}
