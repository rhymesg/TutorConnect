name: Navigation E2E Test

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

env:
  NODE_ENV: production

permissions:
  contents: read
  pull-requests: write

jobs:
  navigation-test:
    name: Test Navigation Flow
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --include=dev
      
    - name: Setup environment
      run: |
        echo "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" >> $GITHUB_ENV
        echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" >> $GITHUB_ENV
        echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_ENV
        echo "JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}" >> $GITHUB_ENV
        echo "JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}" >> $GITHUB_ENV
        echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV
        
    - name: Build application
      run: npm run build
      
    - name: Install Playwright
      run: npx playwright install --with-deps chromium
      
    - name: Start application
      run: |
        npm run start &
        sleep 10
        curl --retry 10 --retry-delay 5 --retry-connrefused http://localhost:3000
      
    - name: Run navigation E2E test
      run: |
        cat > playwright-navigation.config.ts << 'EOF'
        import { defineConfig } from '@playwright/test';

        export default defineConfig({
          testDir: './tests/e2e',
          timeout: 30000,
          expect: { timeout: 5000 },
          fullyParallel: false,
          forbidOnly: !!process.env.CI,
          retries: process.env.CI ? 2 : 0,
          workers: 1,
          reporter: 'html',
          use: {
            baseURL: 'http://localhost:3000',
            trace: 'on-first-retry',
            screenshot: 'only-on-failure',
          },
          projects: [
            {
              name: 'chromium',
              use: { browserName: 'chromium' },
            },
          ],
        });
        EOF
        
        mkdir -p tests/e2e
        cat > tests/e2e/navigation.test.ts << 'EOF'
        import { test, expect } from '@playwright/test';

        test.describe('Navigation Flow', () => {
          test('should navigate to register page from various buttons and links', async ({ page }) => {
            // Test 1: Header "Registrer deg" link
            await page.goto('/');
            
            // Check that we're on the home page
            await expect(page).toHaveURL('/');
            await expect(page.locator('h1')).toContainText('Finn din perfekte');
            
            // Click "Registrer deg" in header
            await page.click('a:has-text("Registrer deg")');
            await expect(page).toHaveURL('/auth/register');
            await expect(page.locator('h1:has-text("Opprett konto")')).toBeVisible();
            
            console.log('✅ Header "Registrer deg" navigation works');
            
            // Test 2: CTA section "Opprett konto" link
            await page.goto('/');
            
            // Scroll to CTA section and click "Opprett konto"
            await page.locator('a:has-text("Opprett konto")').scrollIntoViewIfNeeded();
            await page.click('a:has-text("Opprett konto")');
            await expect(page).toHaveURL('/auth/register');
            await expect(page.locator('h1:has-text("Opprett konto")')).toBeVisible();
            
            console.log('✅ CTA "Opprett konto" navigation works');
            
            // Test 3: Check that register page actually loads properly
            await page.goto('/auth/register');
            
            // Check that all key elements are present
            await expect(page.locator('h1:has-text("Opprett konto")')).toBeVisible();
            await expect(page.locator('input[name="name"]')).toBeVisible();
            await expect(page.locator('input[name="email"]')).toBeVisible();
            await expect(page.locator('input[name="password"]')).toBeVisible();
            await expect(page.locator('button[type="submit"]')).toBeVisible();
            
            console.log('✅ Register page loads completely');
            
            // Test 4: Check "Logg inn her" link back to login
            await page.click('a:has-text("Logg inn her")');
            await expect(page).toHaveURL('/auth/login');
            await expect(page.locator('h2:has-text("Logg inn")')).toBeVisible();
            
            console.log('✅ "Logg inn her" navigation works');
            
            // Test 5: Check breadcrumb navigation (if exists)
            await page.goto('/auth/register');
            
            // Try clicking TutorConnect logo to go back home
            await page.click('a[aria-label*="forsiden"], a:has-text("TutorConnect")');
            await expect(page).toHaveURL('/');
            await expect(page.locator('h1')).toContainText('Finn din perfekte');
            
            console.log('✅ Logo navigation back to home works');
            
            console.log('✅ All main navigation tests passed');
            
            // Test 6: Header navigation links
            await page.goto('/');
            
            // Test "Finn en lærer" in header
            await page.click('a:has-text("Finn en lærer")');
            await expect(page).toHaveURL('/posts?type=teacher');
            
            console.log('✅ Header "Finn en lærer" navigation works');
            
            // Test "Finn en student" in header
            await page.goto('/');
            await page.click('a:has-text("Finn en student")');
            await expect(page).toHaveURL('/posts?type=student');
            
            console.log('✅ Header "Finn en student" navigation works');
            
            // Test "Om oss" in header
            await page.goto('/');
            await page.click('a:has-text("Om oss")');
            await expect(page).toHaveURL('/om-oss');
            
            console.log('✅ Header "Om oss" navigation works');
            
            // Test 7: Footer navigation links
            await page.goto('/');
            
            // Scroll to footer first
            await page.locator('footer').scrollIntoViewIfNeeded();
            
            // Test "Personvern" in footer
            await page.click('a:has-text("Personvern")');
            await expect(page).toHaveURL('/privacy');
            
            console.log('✅ Footer "Personvern" navigation works');
            
            // Test "Vilkår og betingelser" in footer
            await page.goto('/');
            await page.locator('footer').scrollIntoViewIfNeeded();
            await page.click('a:has-text("Vilkår og betingelser")');
            await expect(page).toHaveURL('/terms');
            
            console.log('✅ Footer "Vilkår og betingelser" navigation works');
            
            // Test "Kontakt" in footer (should go to om-oss with anchor)
            await page.goto('/');
            await page.locator('footer').scrollIntoViewIfNeeded();
            await page.click('a:has-text("Kontakt")');
            await expect(page).toHaveURL('/om-oss#kontakt');
            
            console.log('✅ Footer "Kontakt" navigation works');
            
            // Test 8: Verify that target pages exist and load properly
            const pagesToCheck = [
              { url: '/privacy', expectedElement: 'h1, h2' },
              { url: '/terms', expectedElement: 'h1, h2' },
              { url: '/om-oss', expectedElement: 'h1, h2' },
              { url: '/posts?type=teacher', expectedElement: 'h1, h2, main' }
            ];
            
            for (const { url, expectedElement } of pagesToCheck) {
              await page.goto(url);
              await expect(page.locator(expectedElement).first()).toBeVisible({ timeout: 10000 });
              console.log(`✅ Page ${url} loads properly`);
            }
            
            console.log('✅ All navigation and page loading tests passed');
          });
        });
        EOF
        
        npx playwright test --config=playwright-navigation.config.ts
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-navigation-report
        path: playwright-report/
        retention-days: 30